# npm/yarnçš„è®¾è®¡ç¼ºé™·ï¼Œä»¥åŠpnpmæ˜¯å¦‚ä½•æ”¹è¿›çš„

[[toc]]

## ä»€ä¹ˆæ˜¯pnpmï¼Ÿ

[pnpm](https://pnpm.io/) æ ¹æ®å®˜æ–¹ç½‘ç«™çš„ä»‹ç»ï¼Œpnpmæ˜¯performant npmçš„ç¼©å†™ã€‚
> Fast, disk space efficient package manager

æ‰€ä»¥ï¼Œpnpmå’Œnpm/yarnæ˜¯å±äºåŒä¸€ç±»çš„è´¡é…’ã€‚ ç›®å‰ï¼ˆ2021å¹´12æœˆï¼‰ï¼Œè®¸å¤šå¤§å‹çš„å¼€æºé¡¹ç›®ï¼ˆ[vue](https://github.com/vuejs/vue-next), [prisma](https://github.com/prisma/prisma)...) éƒ½è¿ç§»å‘äº†pnpmã€‚ æœ¬æ–‡è¯¦ç»†æ¢è®¨äº†npm/yarnçš„è®¾è®¡ç¼ºé™·ï¼Œä»¥åŠpnpmæ˜¯å¦‚ä½•æ”¹è¿›çš„ã€‚

## ç»“è®º

npm/yarn - ç¼ºç‚¹

- æ‰å¹³çš„node_modulesç»“æ„å…è®¸è®¿é—®æ²¡æœ‰å¼•ç”¨çš„packageã€‚
- æ¥è‡ªä¸åŒé¡¹ç›®çš„packageä¸èƒ½å…±äº«ï¼Œè¿™æ˜¯å¯¹ç£ç›˜ç©ºé—´çš„æ¶ˆè€—ã€‚
- å®‰è£…ç¼“æ…¢ï¼Œå¤§é‡é‡å¤å®‰è£…node_modulesã€‚

pnpm - è§£å†³æ–¹æ¡ˆ

- pnpmä½¿ç”¨ç‹¬åˆ›çš„åŸºäºsymlinkçš„node_modulesç»“æ„ï¼Œåªå…è®¸è®¿é—®package.jsonä¸­çš„å¼•å…¥packagesï¼ˆä¸¥æ ¼ï¼‰ã€‚
- å®‰è£…çš„packageå­˜å‚¨åœ¨ä¸€ä¸ªä»»ä½•æ–‡ä»¶å¤¹éƒ½å¯ä»¥è®¿é—®çš„ç›®å½•é‡Œå¹¶ç”¨ç¡¬è¿æ¥åˆ°å„ä¸ªnode_modulesï¼Œä»¥èŠ‚çœç£ç›˜ç©ºé—´ï¼ˆé«˜æ•ˆï¼‰ã€‚
- æœ‰äº†ä¸Šè¿°æ”¹å˜ï¼Œå®‰è£…ä¹Ÿä¼šæ›´å¿«ï¼ˆå¿«é€Ÿï¼‰ã€‚

ä»å®˜æ–¹ç½‘ç«™ä¸Šçœ‹ï¼Œä¸¥æ ¼ã€é«˜æ•ˆã€å¿«é€Ÿå’Œå¯¹äºmonorepoçš„æ”¯æŒæ˜¯pnpmçš„å››å¤§ç‰¹ç‚¹ã€‚ä½†æœ€æ–°çš„npm8å’Œyarnéƒ½æ”¯æŒworkspaces,è™½ç„¶æ”¯æŒçš„ç¨‹åº¦å„æœ‰ä¸åŒï¼Œä½†æˆ‘å¹¶ä¸è®¤ä¸ºè¿™æ˜¯npm/yarnçš„ä¸è¶³ç‚¹ã€‚æˆ‘ä»¬å°†åœ¨æœ€åç¨å¾®è®¨è®ºä¸€ä¸‹pnpmå¯¹äºmonorepoæ”¯æŒã€‚

## ç£ç›˜ç©ºé—´

### npm/yarn- æ¶ˆè€—ç£ç›˜ç©ºé—´çš„node_modules

npm/yarnæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ä½¿ç”¨äº†å¤ªå¤šçš„ç£ç›˜ç©ºé—´, å¦‚æœä½ å®‰è£…åŒä¸€ä¸ªåŒ…100æ¬¡ï¼Œ100åˆ†çš„å°±ä¼šè¢«å‚¨å­˜åœ¨ä¸åŒçš„node_modulesæ–‡ä»¶å¤¹ä¸‹ã€‚ ä¸¾ä¸€ä¸ªå¸¸æœ‰çš„çš„ä¾‹å­ï¼Œå¦‚æœå®Œæˆäº†ä¸€ä¸ªé¡¹ç›®ï¼Œè€Œnode_modulesæ²¡æœ‰åˆ æ‰ä¿ç•™äº†ä¸‹æ¥ï¼Œå¾€å¾€ä¼šå ç”¨å¤§é‡çš„ç£ç›˜ç©ºé—´ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ç»å¸¸ä½¿ç”¨[npkill](https://npkill.js.org/)ã€‚

```shell
$ npx npkill
```
å¯ä»¥æ‰«æå½“å‰æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰node_modulesï¼Œå¹¶åŠ¨æ€åœ°åˆ é™¤å®ƒä»¬ã€‚

### pnpm - é«˜æ•ˆçš„ä½¿ç”¨ç£ç›˜ç©ºé—´

å¦ä¸€æ–¹é¢ï¼Œpnpmå°†åŒ…å­˜å‚¨åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­ï¼ˆcontent-addressable storeï¼‰ï¼Œåªè¦å½“ä½ åœ¨åŒä¸€OSçš„åŒä¸€ä¸ªç”¨æˆ·åœ¨ä¸‹å†æ¬¡å®‰è£…æ—¶å°±åªéœ€è¦åˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ã€‚ MacOsçš„é»˜è®¤ä½ç½®æ˜¯~/.pnpm-storeï¼Œç”šè‡³å½“å®‰è£…åŒä¸€packageçš„ä¸åŒç‰ˆæœ¬æ—¶ï¼Œåªæœ‰ä¸åŒçš„éƒ¨åˆ†ä¼šè¢«é‡æ–°ä¿å­˜ã€‚ ä¹Ÿå°±æ˜¯è¯´ç„¶åå½“ä½ å®‰è£…ä¸€ä¸ªpackageæ—¶ï¼Œå¦‚æœå®ƒåœ¨storeé‡Œï¼Œå»ºç«‹ç¡¬è¿æ¥æ–°ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¸‹è½½ä¿å­˜åœ¨storeå†åˆ›å»ºç¡¬è¿æ¥ã€‚

ä½¿ç”¨ç¡¬é“¾æ¥åšåˆ°çš„æ˜¯

- å®‰è£…é€Ÿåº¦éå¸¸å¿«([åŸºå‡†](https://pnpm.io/benchmarks)ç”šè‡³æ¯”yarnçš„[pnpæ¨¡å¼](https://classic.yarnpkg.com/en/docs/pnp/)æ›´å¿«ï¼)
- èŠ‚çœç£ç›˜ç©ºé—´

ä¸‹é¢æ˜¯åœ¨ä¸€å°å®‰è£…è¿‡expressçš„ç”µè„‘ä¸Šé‡æ–°å®‰è£…çš„ç»“æœã€‚é¡ºä¾¿æŠŠnpm/yarnå®‰è£…çš„è¾“å‡ºç»“æœè´´å‡ºæ¥ã€‚

pnpm

```
$ pnpm i express
Packages: +52
++++++++++++++++++++++++++++++++++++++++++++++++++++
Progress: resolved 52, reused 52, downloaded 0, added 0, done

dependencies:
+ express 4.17.1
```

npm

```
$ npm i express
npm WARN npm@1.0.0 No description
npm WARN npm@1.0.0 No repository field.

+ express@4.17.1
added 50 packages from 37 contributors and audited 50 packages in 4.309s
found 0 vulnerabilities
```

yarn

```
$ yarn add express
yarn add v1.22.11
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
[4/4] ğŸ”¨  Building fresh packages...

success Saved lockfile.
success Saved 29 new dependencies.
info Direct dependencies
â””â”€ express@4.17.1
info All dependencies
â”œâ”€ accepts@1.3.7
â”œâ”€ array-flatten@1.1.1
â”œâ”€ body-parser@1.19.0
â”œâ”€ content-disposition@0.5.3
â”œâ”€ cookie-signature@1.0.6
â”œâ”€ cookie@0.4.0
â”œâ”€ destroy@1.0.4
â”œâ”€ ee-first@1.1.1
â”œâ”€ express@4.17.1
â”œâ”€ finalhandler@1.1.2
â”œâ”€ forwarded@0.2.0
â”œâ”€ inherits@2.0.3
â”œâ”€ ipaddr.js@1.9.1
â”œâ”€ media-typer@0.3.0
â”œâ”€ merge-descriptors@1.0.1
â”œâ”€ methods@1.1.2
â”œâ”€ mime-db@1.51.0
â”œâ”€ mime@1.6.0
â”œâ”€ ms@2.0.0
â”œâ”€ negotiator@0.6.2
â”œâ”€ path-to-regexp@0.1.7
â”œâ”€ proxy-addr@2.0.7
â”œâ”€ raw-body@2.4.0
â”œâ”€ safer-buffer@2.1.2
â”œâ”€ serve-static@1.14.1
â”œâ”€ type-is@1.6.18
â”œâ”€ unpipe@1.0.0
â”œâ”€ utils-merge@1.0.1
â””â”€ vary@1.1.2
âœ¨  Done in 1.14s.
```

æˆ‘ç”šè‡³è®¤ä¸ºpnpmåœ¨è¾“å‡ºæ˜“æ‡‚æ–¹é¢ä¹Ÿç•¥èƒœä¸€ç­¹ï¼Œå› ä¸ºä½ å¯ä»¥ç«‹å³çœ‹åˆ°ä½ é‡ç”¨äº†å¤šå°‘åŒ…å’Œé‡æ–°ä¸‹è½½äº†å¤šå°‘åŒ…è€Œå¹¶ä¸åƒyarnæŠŠæ‰€æœ‰å…³è”çš„åŒ…éƒ½ä»¥åˆ—è¡¨çš„å½¢å¼åˆ—å‡ºæ¥ï¼Œå› ä¸ºå¤§æ¦‚ç‡æˆ‘ä»¬å¹¶ä¸åœ¨æ„è¿™äº›ã€‚

## node_modulesç»“æ„å’Œä¾èµ–æ€§è§£æ

ç°åœ¨å¼€å§‹è¯·è€ƒè™‘åŒæ ·ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šå®‰è£…ä¸€ä¸ªä¾èµ–äºbarçš„fooåŒ…ã€‚

npm/yarnç»å†äº†ä¸‰æ¬¡é‡å¤§çš„æ›´æ–°ï¼Œæ‰é€æ¸å½¢æˆäº†ç°åœ¨çš„å½¢å¼ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªåœ°çœ‹ï¼Œä¸€è¾¹äº†è§£pnpmçš„æ”¹è¿›ã€‚

### npm1 - åµŒå¥—å¼çš„node_modules

ç”±äºfooä¾èµ–äºbarï¼Œæœ€ç®€å•çš„æ€è€ƒæ–¹å¼æ˜¯baråº”è¯¥è¢«æ”¾åœ¨fooçš„node_modulesä¸­ã€‚
npm1é‡‡ç”¨äº†åŒæ ·çš„æƒ³æ³•ï¼Œæ‰€ä»¥å®ƒçš„ç»“æ„æ˜¯è¿™æ ·çš„ã€‚

```
.
â””â”€â”€ node_modules
    â””â”€â”€ foo
        â”œâ”€â”€ index.d.ts
        â”œâ”€â”€ package.json
        â””â”€â”€ node_modules
            â””â”€â”€ bar
                â”œâ”€â”€ index.js
                â””â”€â”€ package.json
```

å¦‚æœbaræœ‰å…¶ä»–ä¾èµ–ï¼Œä¾‹å¦‚lodashï¼Œé‚£æŒ‰æˆ‘ä»¬çš„ç†è®ºå®ƒå°†è¿›å…¥barçš„node_modulesï¼Œè¿™å°±æ˜¯æ‰€è°“çš„åµŒå¥—node_modulesã€‚ é‚£ä¹ˆè¿™ç§ç»“æ„æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

```
.
â””â”€â”€ node_modules
    â””â”€â”€ foo
        â”œâ”€â”€ index.js
        â”œâ”€â”€ package.json
        â””â”€â”€ node_modules
            â””â”€â”€ bar
                â”œâ”€â”€ index.js
                â”œâ”€â”€ package.json
                â””â”€â”€ node_modules
                    â””â”€â”€ lodash
                        â”œâ”€â”€ index.js
                        â””â”€â”€ package.json
```

æ˜¯çš„ï¼è¿™å¾ˆå®¹æ˜“å½¢æˆè¿‘ä¼¼æ— é™çš„åµŒå¥—ã€‚ å¦‚æœæœ€ç»ˆçš„è·¯å¾„å¤ªæ·±ï¼Œä¼šæœ‰ä»¥ä¸‹é—®é¢˜

- è·¯å¾„å¤ªé•¿ï¼Œè¶…è¿‡windowsè·¯å¾„é•¿åº¦çš„é™åˆ¶ã€‚
- å¤§é‡çš„é‡å¤å®‰è£…ã€‚å¦‚æœfooå’Œbarä¾èµ–äºåŒä¸€ç‰ˆæœ¬çš„loadshï¼Œé‚£ä¹ˆåœ¨å®‰è£…æ—¶ï¼Œç‹¬ç«‹çš„ node_modulesä¼šæœ‰å®Œå…¨ç›¸åŒçš„lodashã€‚
- ä¸èƒ½å…±äº«ç›¸åŒçš„å®ä¾‹å€¼ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä»ä¸åŒçš„åœ°æ–¹å¼•ç”¨Reactï¼Œå®ƒå°†æ˜¯ä¸€ä¸ªä¸åŒçš„å®ä¾‹ï¼Œæ‰€ä»¥åº”è¯¥å…±äº«çš„å†…éƒ¨å˜é‡ä¸èƒ½è¢«å…±äº«ã€‚

### npm3/yarn - æ‰å¹³åŒ–çš„node_modules

ä»npm3å¼€å§‹ï¼ˆä¹ŸåŒ…æ‹¬yarnï¼‰ï¼Œæ‰å¹³åŒ–çš„node_modulesä¸€ç›´è¢«é‡‡ç”¨å¹¶ä½¿ç”¨åˆ°ç°åœ¨ã€‚nodejsçš„[ä¾èµ–è§£æ](https://nodejs.org/api/modules.html#all-together)ç®—æ³•æœ‰ä¸€ä¸ªè§„åˆ™ï¼Œå¦‚æœå®ƒåœ¨å½“å‰ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ°node_modulesï¼Œå®ƒå°†é€’å½’è§£æçˆ¶ç›®å½•ä¸‹çš„node_modulesï¼Œé‚£ä¹ˆåˆ©ç”¨è¿™ä¸€ç‚¹æŠŠæ‰€æœ‰å¼•ç”¨çš„åŒ…æ”¾åœ¨é¡¹ç›®ä¸‹node_modulesä¸­ï¼Œå°±å¯ä»¥è§£å†³æ‰€æœ‰åŒ…çš„ä¸å…±äº«å’Œè¿‡é•¿çš„ä¾èµ–è·¯å¾„é—®é¢˜ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç»“æ„å°†ä¼šçœ‹èµ·æ¥åƒè¿™æ ·

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ bar
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json
```

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå•å•æ˜¯å®‰è£…expressï¼Œnode_modulesé‡Œä¼šæœ‰50å‡ ä¸ªæ–‡ä»¶å¤¹çš„åŸå› ï¼Œä»–ä»¬éƒ½è¢«å¹³é“ºåˆ°äº†node_modulesä¸‹ã€‚

ä½†æ˜¯åˆæœ‰äº†æ–°çš„é—®é¢˜ã€‚
1. package.jsoné‡Œå¹¶æ²¡æœ‰å†™å…¥çš„åŒ…ç«Ÿç„¶ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†([Phantom](https://rushjs.io/pages/advanced/phantom_deps/) - å¹»å½±ä¾èµ–)ã€‚
2. node_moduleså®‰è£…çš„ä¸ç¨³å®šæ€§ï¼ˆ[Doppelgangers](https://rushjs.io/pages/advanced/npm_doppelgangers/) - åˆ†èº«ä¾èµ–ï¼‰ã€‚
3. å¹³é“ºå¼çš„node_modulesç®—æ³•å¤æ‚ï¼Œè€—è´¹æ—¶é—´ã€‚

#### Phantom

å¦‚æœä½ å®‰è£…äº†ä¾èµ–barçš„fooï¼Œä½ å°±å¯ä»¥ç›´æ¥è®¿é—®barï¼Œå› ä¸ºå®ƒä¹Ÿåœ¨node_modulesä¸‹ã€‚
å¦‚æœå®ƒè¢«ä¸ç»æ„åœ°ç”¨åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œè€Œæœ‰ä¸€å¤©fooåœæ­¢ä½¿ç”¨barï¼Œæˆ–è€…barè¢«å‡çº§åˆ°ä¸€ä¸ªè¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œé¡¹ç›®ä»£ç ä¸­å¼•ç”¨çš„barçš„çŠ¶æ€å¯èƒ½ä¼šæ”¹å˜ï¼Œå¹¶å¯¼è‡´æ„å¤–çš„é”™è¯¯ã€‚

#### Doppelgangers

Doppelgangersä¼šæ¯”è¾ƒå¤æ‚ï¼Œä»ä¸Šé¢çš„ä¾‹å­é‡ŒåŠ å…¥fooä¾èµ–äºlodash@1.0.0ï¼Œbarä¾èµ–äºlodash@1.0.1

```
foo - lodash@1.0.0
bar - lodash@1.0.1
```

è¿™æ ·çš„è¯ï¼Œæ ¹æ®nodejsã®[ä¾èµ–è§£æ](https://nodejs.org/api/modules.html#all-together)ãƒ«ãƒ¼ãƒ«ã§ã¯ã€require(PACKAGE_NAME)çš„PACKAGE_NAMEå¿…é¡»æ˜¯node_modulesä¸‹åŒåçš„æ–‡ä»¶ä¸‹ï¼Œåƒè¿™æ ·åŠ å…¥ç‰ˆæœ¬å·çš„åç§°PACKAGE_NAMEï¼ VERSIONæ˜¯ä¸è¡Œçš„ã€‚é‚£è¿™æ ·çš„è¯ï¼Œç»“æ„æ˜¯

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â”œâ”€â”€ bar
    â”‚   â”œâ”€â”€ index.js
    â”‚   â”œâ”€â”€ package.json
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ lodash
    â”‚           â”œâ”€â”€ index.js
    â”‚           â””â”€â”€ package.json(@1.0.1)
    â””â”€â”€ lodash
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json(@1.0.0)
```

è¿˜æ˜¯

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo
    â”‚   â”œâ”€â”€ index.js
    â”‚   â”œâ”€â”€ package.json
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ lodash
    â”‚           â”œâ”€â”€ index.js
    â”‚           â””â”€â”€ package.json(@1.0.0)
    â”œâ”€â”€ bar
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ lodash
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json(@1.0.1)
```

è¿™æ ·å‘¢ï¼Ÿ

ç„¶è€Œç»“æœæ˜¯éƒ½æœ‰å¯èƒ½ã€‚

ä¼šæ ¹æ®fooå’Œbaråœ¨package.jsonä¸­çš„ä½ç½®å†³å®šã€‚fooåœ¨ä¸Šé¢çš„è¯å°±æ˜¯ä¸Šé¢çš„ç»“æ„å¦åˆ™çš„è¯å°±æ˜¯ä¸‹é¢çš„ç»“æ„ã€‚
è¿™æ ·çš„ä¸ç¡®å®šæ€§å«åšDoppelgangersã€‚


### npm5.x/yarn - å¸¦æœ‰lockæ–‡ä»¶çš„å¹³é“ºå¼çš„node_modules

å¼•å…¥äº†ä¸€ä¸ªlockæ–‡ä»¶ï¼Œä»¥è§£å†³node_moduleså®‰è£…ä¸­çš„ä¸ç¡®å®šå› ç´ ã€‚ è¿™ä½¿å¾—æ— è®ºä½ å®‰è£…å¤šå°‘æ¬¡ï¼Œéƒ½èƒ½æœ‰ä¸€ä¸ªä¸€æ ·ç»“æ„çš„node_modulesã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆlockæ–‡ä»¶åº”è¯¥å§‹ç»ˆåŒ…å«åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­å¹¶ä¸”ä¸åº”è¯¥æ‰‹åŠ¨ç¼–è¾‘çš„åŸå› ã€‚

ç„¶è€Œï¼Œå¹³é“ºå¼çš„ç®—æ³•çš„å¤æ‚æ€§ï¼Œä»¥åŠPhantomã€æ€§èƒ½å’Œå®‰å…¨é—®é¢˜ä»æœªå¾—åˆ°è§£å†³ã€‚


### pnpm - åŸºäºç¬¦å·é“¾æ¥çš„node_modulesç»“æ„

è¿™ä¸€éƒ¨åˆ†ç•¥å¾®å¤æ‚ï¼Œæˆ‘è§‰å¾—æœ€å¥½çš„è§£é‡Šæ–¹å¼æ˜¯åœ¨å®˜æ–¹ç½‘ç«™ä¸Šçš„[èª¬æ˜](https://pnpm.io/symlinked-node-modules-structure)ï¼Œæ‰€ä»¥åœ¨è¿™è¾¹åŸºäºè¿™ç¯‡æ–‡ç« åŠ ä¸Šè‡ªå·±çš„ç†è§£æ˜¯è¿™è¯´æ˜ä¸€ä¸‹ã€‚

ç”Ÿæˆnode_modulesä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ã€‚

#### åŸºäºç¡¬è¿æ¥çš„node_modules

```
.
â””â”€â”€ node_modules
    â””â”€â”€ .pnpm
        â”œâ”€â”€ foo@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â””â”€â”€ foo -> <store>/foo
        â””â”€â”€ bar@1.0.0
            â””â”€â”€ node_modules
                â””â”€â”€ bar -> <store>/bar
```
ä¹ä¸€çœ‹ï¼Œç»“æ„ä¸npm/yarnçš„ç»“æ„å®Œå…¨ä¸åŒï¼Œç¬¬ä¸€æ‰‹node_modulesä¸‹é¢çš„å”¯ä¸€æ–‡ä»¶å¤¹å«åš.pnpmã€‚åœ¨.pnpmä¸‹é¢æ˜¯ä¸€ä¸ª<PACKAGE_NAMEï¼ VERSION>æ–‡ä»¶å¤¹ï¼Œè€Œåœ¨å…¶ä¸‹é¢<PACKAGE_NAME>çš„æ–‡ä»¶å¤¹æ˜¯ä¸€ä¸ªcontent-addressable storeçš„ç¡¬é“¾æ¥ã€‚ å½“ç„¶ä»…ä»…æ˜¯è¿™æ ·è¿˜æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥è½¯é“¾æ¥ä¹Ÿå¾ˆå…³é”®ã€‚

#### ç”¨äºä¾èµ–è§£æçš„è½¯é“¾æ¥

- ç”¨äºåœ¨fooå†…å¼•ç”¨barçš„è½¯é“¾æ¥
- åœ¨é¡¹ç›®é‡Œå¼•ç”¨fooçš„è½¯é“¾æ¥

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
    â””â”€â”€ .pnpm
        â”œâ”€â”€ foo@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â”œâ”€â”€ foo -> <store>/foo
        â”‚       â””â”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
        â””â”€â”€ bar@1.0.0
            â””â”€â”€ node_modules
                â””â”€â”€ bar -> <store>/bar
```

å½“ç„¶è¿™åªæ˜¯ä½¿ç”¨pnpmçš„node_modulesç»“æ„æœ€ç®€å•çš„ä¾‹å­ï¼ä½†å¯ä»¥å‘ç°é¡¹ç›®ä¸­èƒ½ä½¿ç”¨çš„ä»£ç åªèƒ½æ˜¯package.jsonä¸­å®šä¹‰è¿‡çš„ï¼Œå¹¶ä¸”å®Œå…¨å¯ä»¥åšåˆ°æ²¡ç”¨æ— ç”¨çš„å®‰è£…ã€‚[peers dependencies](https://pnpm.io/how-peers-are-resolved)çš„è¯ä¼šæ¯”è¿™ä¸ªç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†ä¸€æ—¦ä¸è€ƒè™‘peerçš„è¯ä»»ä½•å¤æ‚çš„ä¾èµ–éƒ½å¯ä»¥å®Œå…¨ç¬¦åˆè¿™ç§ç»“æ„ã€‚

ä¾‹å¦‚ï¼Œå½“fooå’ŒbaråŒæ—¶ä¾èµ–äºlodashçš„æ—¶å€™ï¼Œå°±ä¼šåƒä¸‹å›¾è¿™æ ·çš„ç»“æ„ã€‚

```
.
â””â”€â”€ node_modules
    â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
    â””â”€â”€ .pnpm
        â”œâ”€â”€ foo@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â”œâ”€â”€ foo -> <store>/foo
        â”‚       â”œâ”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
        â”‚       â””â”€â”€ lodash -> ../../lodash@1.0.0/node_modules/lodash
        â”œâ”€â”€ bar@1.0.0
        â”‚   â””â”€â”€ node_modules
        â”‚       â”œâ”€â”€ bar -> <store>/bar
        â”‚       â””â”€â”€ lodash -> ../../lodash@1.0.0/node_modules/lodash
        â””â”€â”€ lodash@1.0.0
            â””â”€â”€ node_modules
                â””â”€â”€ lodash -> <store>/lodash
```

è¿™æ ·çš„è¯ï¼Œä¸ç®¡æ˜¯å¦‚ä½•å¤æ‚çš„ä¾èµ–å…³ç³»éƒ½å¯ä»¥ç”¨è¿™æ ·çš„æ–‡ä»¶å¤¹ç»“æ„æ¥æ„æˆï¼Œéå¸¸æœ‰åˆ›æ–°æ€§çš„ç»“æ„ï¼


### pnpmä»¥å¤–ã®è§£æ±ºæ³•

#### npm global-style

npmä¹Ÿæ›¾ç»ä¸ºäº†è§£å†³æ‰å¹³å¼node_modulesçš„é—®é¢˜æä¾›è¿‡ï¼Œé€šè¿‡æŒ‡å®š[global-style](https://docs.npmjs.com/cli/v8/using-npm/config#global-style)æ¥ç¦æ­¢å¹³é“ºnode_modulesï¼Œä½†è¿™æ— ç–‘åˆé€€å›äº†åµŒå¥—å¼çš„node_modulesæ—¶ä»£çš„é—®é¢˜ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰æ¨å¹¿å¼€æ¥ã€‚

#### dependency-check
å…‰é npm/yarnçš„è¯çœ‹ä¼¼æ— æ³•è§£å†³ï¼Œæ‰€ä»¥åŸºç¡€ç¤¾åŒºçš„è§£å†³æ–¹æ¡ˆ[dependency-check](https://github.com/dependency-check-team/dependency-check)ä¹Ÿç»å¸¸è¢«ç”¨åˆ°ã€‚

```
$ dependency-check ./package.json --verbose
Success! All dependencies used in the code are listed in package.json
Success! All dependencies in package.json are used in the code
```
æœ‰äº†æœ¬æ–‡çš„åŸºç¡€ï¼Œå…‰æ˜¯çœ‹åˆ°READMEå†…ä¸€æ®µå‘½ä»¤è¡Œçš„è¾“å‡ºåº”è¯¥ä¹Ÿèƒ½æƒ³è±¡åˆ°dependency-checkæ˜¯å¦‚ä½•å·¥ä½œçš„äº†å§ï¼

æœç„¶å’Œå…¶ä»–çš„è§£å†³æ–¹æ¡ˆæ¯”ï¼Œpnpmæ˜¾å¾—æœ€ä¸ºä¼˜é›…å§ã€‚

## é¢å¤–è¡¥å……

### åŸºæœ¬çš„å‘½ä»¤

é€šè¿‡ä¸Šæ–‡çš„æè¿°ï¼Œpnpmç»™äººéå¸¸å¤æ‚çš„æ„Ÿè§‰ï¼Œä½†å®é™…ç”¨èµ·æ¥åè€Œç›¸åï¼Œéå¸¸éå¸¸çš„ç®€å•ï¼
å¯¹äºä½¿ç”¨è¿‡npm/yarnçš„å¼€å‘è€…æ¥è¯´ã€å‡ ä¹ä¸éœ€è¦ä»»ä½•çš„å­¦ä¹ æˆæœ¬ã€‚ä¸ä¿¡çš„è¯å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­

```shell
pnpm install express
pnpm update express
pnpm remove express
```

å‡ ä¹å’Œç†Ÿæ‚‰çš„å‘½ä»¤æ²¡æœ‰åŒºåˆ«ï¼Œå¯¹å§ï¼

### monorepoçš„æ”¯æŒ

pnpmæ˜¯å¯¹äºå¯¹äºmonorepoæ”¯æŒçš„ã€‚pnpmçš„ä½œè€…ç”šè‡³å†™è¿‡[ä¸lernaå…³äºå¤šä¸ªåŒ…å‘½ä»¤çš„å‘½ä»¤è¡Œæ¯”è¾ƒ](https://medium.com/pnpm/pnpm-vs-lerna-filtering-in-a-multi-package-repository-1f68bc644d6a)ã€‚å¦‚æœè¯¦ç»†è¯´æ˜çš„è¯ï¼Œé‚£å°±æ˜¯å¦ä¸€ç¯‡æ–‡ç« äº†ã€‚ä¸‹é¢ä¹‹ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚

```shell
pnpm --parallel  run --recursive  --filter @xyh test
```
æ‰§è¡Œè¿™æ®µå‘½ä»¤çš„è¯ï¼Œå°±ä¼šå¼‚æ­¥æ‰§è¡Œ@xyhå­—æ®µä¸‹workspaceçš„npm script testï¼Œä¹‹å‰éœ€è¦é¢å¤–å®‰è£…lernaè¿™ç§monorepoç®¡ç†å·¥å…·çš„åœºæ™¯ä¹Ÿåªéœ€è¦pnpmå°±èƒ½åšåˆ°äº†ã€‚
